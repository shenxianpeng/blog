---
title: 使用 Gcov 和 LCOV 对 C/C++ 项目衡量代码覆盖率
tags:
  - Gcov
  - LCOV
  - Coverage
categories:
  - Coverage
date: 2021-07-12 00:10:21
author: shenxianpeng
---

本篇主要分享如何使用 Gcov 和 LCOV 对 C/C++ 项目进行代码覆盖率。如果你的工作中不涉及代码覆盖率的工作，本篇就可以跳过了。

如果你也需要做代码覆盖率的工作，希望本篇对你有所帮助。

## 问题

如果你的 C/C++ 项目没有单元测试只有黑盒的自动化测试用例但还想做代码覆盖率测试怎么办？

## 现状

市场上有一些工具可以在没有单元测试用例的情况下对 C/C++ 项目测量它的代码覆盖率，比如 Squish Coco，Bullseye。

其中我比较深入的使用了 [Squish Coco](https://shenxianpeng.github.io/2019/05/squishcoco/)，做一个简单的 demo 演示是没有问题的，但对于大型项目，引入这类工具都或多或少的需要解决编译上的问题。

也正是因为还有一些编译问题没有解决，就一直没有购买 Squish Coco 正式版价格不菲的 License。

当我今年再次开始调查代码覆盖率的时候，我很惭愧的才知道 GCC 其实是有内置的测试覆盖率的工具，叫 [Gcov](https://gcc.gnu.org/onlinedocs/gcc/Gcov.html)

为了能更好的展示它是如何工作，我准备了一段示例程序，根据下面的步骤相信你会对 Gcov 是如何工作了有了一定的了解。

## 前提条件

如果你想运行这个示例程序，你需要先安装 [GCC](https://gcc.gnu.org/install/index.html) 和 [lcov](http://ltp.sourceforge.net/coverage/lcov.php) 这两个工具。

```bash
# 这是我的测试环境上的 GCC 和 lcov 的版本
sh-4.2$ gcc --version
gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-39)
Copyright (C) 2015 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

sh-4.2$ lcov -v
lcov: LCOV version 1.14
```

## 如何运行

这是我接下里要分享的示例程序的 GitHub 仓库地址 https://github.com/shenxianpeng/gcov-example

### 1. 编译

第一步先编译，我已经将编译用到的参数和文件都写在了 `makefile` 文件里了，只要执行 `make` 就可以编译了。

```bash
make
```

<details>
<summary>点击查看 make 命令的输出</summary>

```bash
sh-4.2$ make
gcc -fPIC -fprofile-arcs -ftest-coverage -c -Wall -Werror main.c
gcc -fPIC -fprofile-arcs -ftest-coverage -c -Wall -Werror foo.c
gcc -fPIC -fprofile-arcs -ftest-coverage -o main main.o foo.o
```
</details>

通过输出可以看到，这个程序在编译的时候填加了两个编译选项 `-fprofile-arcs` and `-ftest-coverage`。在编译成功后，不仅生成了 `main` and `.o` 文件，同时还生成了两个 `.gcno` 文件.

> `.gcno` 记录文件是在加入 GCC 编译选项 `-ftest-coverage` 后生成的，在编译过程中它包含用于重建基本块图和为块分配源行号的信息。

### 2. 运行可执行文件

在编译完成后，生成了 `main` 这个可执行文件，运行它：

```bash
./main
```

<details>
<summary>点击查看运行 main 时输出</summary>

```bash
sh-4.2$ ./main
Start calling foo() ...
when num is equal to 1...
when num is equal to 2...
```

</details>

当运行 `main` 后，执行的结果被记录在了 `.gcda` 这个数据文件里，查看当前目录下可以看到一共有两个 `.gcda` 文件生成了，即每个源文件都对应一个  `.gcda` 文件。

```bash
$ ls
foo.c  foo.gcda  foo.gcno  foo.h  foo.o  img  main  main.c  main.gcda  main.gcno  main.o  makefile  README.md
```

> `.gcda` 记录数据文件的生成是因为程序在编译的时候引入了 `-fprofile-arcs` 选项。它包含弧过渡计数、值分布计数和一些摘要信息。

### 3. 生成报告

```bash
make report
```

<details>
<summary> 点击查看生成报告的输出 </summary>

```bash
sh-4.2$ make report
gcov main.c foo.c
File 'main.c'
Lines executed:100.00% of 5
Creating 'main.c.gcov'

File 'foo.c'
Lines executed:85.71% of 7
Creating 'foo.c.gcov'

Lines executed:91.67% of 12
lcov --capture --directory . --output-file coverage.info
Capturing coverage data from .
Found gcov version: 4.8.5
Scanning . for .gcda files ...
Found 2 data files in .
Processing foo.gcda
geninfo: WARNING: cannot find an entry for main.c.gcov in .gcno file, skipping file!
Processing main.gcda
Finished .info-file creation
genhtml coverage.info --output-directory out
Reading data file coverage.info
Found 2 entries.
Found common filename prefix "/workspace/coco"
Writing .css and .png files.
Generating output.
Processing file gcov-example/main.c
Processing file gcov-example/foo.c
Writing directory view page.
Overall coverage rate:
  lines......: 91.7% (11 of 12 lines)
  functions..: 100.0% (2 of 2 functions)
```
</details>

Finally, execute `make report` to generate the HTML report, which does the following things:

First, generate `.gcov` file

When the two files `.gcno` and `.gcda` were created, the report file can be generated by the `gcov` command, `.gcov` file is generated when running `gcov main.c foo.c` command.

Second, generate HTML report

Although the above output can know the code coverage of the two source files `main.c` and `foo.c`, but it is not visualized.

We need a tool that can visualize the results, `LCOV` is a tool that can help us generate more intuitive HTML reports.

1. `lcov --capture --directory . --output-file coverage.info` command to generate coverage.info data file.

2. `genhtml coverage.info --output-directory out` to generate HTML report.

> LCOV is a graphical front-end for GCC's coverage testing tool gcov. It collects gcov data for multiple source files and creates HTML pages containing the source code annotated with coverage information. It also adds overview pages for easy navigation within the file structure. LCOV supports statement, function and branch coverage measurement.

### 4. Delete all generate files

```bash
make clean
```

<details>
<summary> click to expand the output of make clean</summary>

```bash
sh-4.2$ make clean
rm -rf main *.o *.so *.gcno *.gcda *.gcov coverage.info out
```
</details>

## Code coverage report

![index](gcov-example/index.png)

![example](gcov-example/example.png)

![main.c](gcov-example/main.c.png)

![foo.c](gcov-example/foo.c.png)

Note: git checkout to `coverage` branch, under `out` directory to view or download the HTML report.

> The `master` branch only saves source files such as `.c`, `.h`, and `makefile` only to be used for demonstration. \
> The `coverage` branch saves all the files generated during the demonstration process, as well as the final code coverage HTML report file (under the `out` directory).

## Reference

Some helpful documents links about this research:

* Gcov homepage: https://gcc.gnu.org/onlinedocs/gcc/Gcov.html
* Lcov homepage: http://ltp.sourceforge.net/coverage/lcov.php

* gcovr homepage: https://github.com/gcovr/gcovr （Another HTML report generation tool implemented in Python, the report display is slightly different from Lcov.)

* Gcov Data File Relocation to Support Cross-Profiling
    * https://gcc.gnu.org/onlinedocs/gcc/Cross-profiling.html#Cross-profiling
    * https://stackoverflow.com/questions/7671612/crossprofiling-with-gcov-but-gcov-prefix-and-gcov-prefix-strip-is-ignored

* Using gcov with the Linux kernel: https://01.org/linuxgraphics/gfx-docs/drm/dev-tools/gcov.html
