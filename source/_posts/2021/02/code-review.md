---
title: Google 的代码审查法则以及我的实践和思考
tags:
  - Review
  - PR
  - Code
categories:
  - DevOps
date: 2021-02-25 17:10:14
author: shenxianpeng
---

Code Review 每个人都知道它很好，应该去好好做，但往往执行起来效果并不好。一来读别人代码需要花时间，往往还需要对方给你讲，执行成本太高；二来自己手头的工作也很多，时间不允许，执行不到位。

如果你还不知道如何开展 Code Review 以及如何定规则，Google 的这篇关于 Code Review 的文章可供借鉴，里面提到了很多具体的 Review 法则。

## Google 的代码审查法则

在进行代码审查时，应确保：

* 代码经过精心设计
* 该功能对代码用户很有帮助
* 任何 UI 更改都是明智的，并且看起来不错
* 任何并行编程都是安全完成的
* 代码没有比需要的复杂
* 开发人员没有实现他们将来可能需要的东西，但不知道他们现在需要什么
* 代码具有适当的单元测试。
* 测试经过精心设计
* 开发人员对所有内容使用了清晰的名称。
* 注释清晰实用，并且主要说明原因而不是原因
* 代码已正确文档化（通常在g3doc中，Google内部工程文档平台）。
* 该代码符合我们的样式指南

确保检查要求你检查的每一行代码，查看上下文，确保你在改善代码运行状况，并称赞开发人员所做的出色工作。

> https://google.github.io/eng-practices/review/reviewer/looking-for.html


下面我在结合我的经验从**流程、自动化、自我要求**方面分享一些想法。

## 流程

**规避任何不经 Review 的代码进入到主分支**

> 我使用的是 Bitucket，因此下面都是以 Bitucket 为例。GitHub 以及 GitLab 在设置上大同小异。

* 打开分支权限设置里的选项 `Prevent changes without a pull request` 打开它。另外，这个选项里也可以添加 Exception，就是这些人可以不通过 Pull Reuqest 来提交代码。

* 在 Merge Check 里开启 `Minimum approvals` 这个选项，我的设置 Number of approvals = 1，及比如有一人点击 Approve 按钮才允许 Merge

## 自动化

**通过 CI/CD，自动化进行编译和测试验证**

* 建立自动化构建和自动化测试的 Pipeline，能够在创建 Pull Request 的时候，或是针对任何分支进行构建和测试。比如 Jenkins 的 Multi-branch pipeline 功能。

* 当上面的 Pipeline 已经稳定，开启在 Bitucket 的 Merge Check 里 `Minimum successful builds` 选项，以防止任何没有通过编译和测试的代码进入主分支。

* 可以通过写一个小工具来分析每次的 Pull Request 里有哪些文件做了修改，假定这些文件过往的历史中哪个人修改的次数最多，就认为这个人对这部分的代码最为熟悉，然后推荐他来作为 Reiewer。这里的推荐机制可以再完善，这里只是提供一个思路。
## 自我要求

最后我想从责任感和品味来谈谈自我要求。

这个不是每个人都有的，如果你喜欢你的产品，你觉得自己的工作很有意义，那么你一定愿意去保障你每提交的任何代码的正确性。不论我作为提交者还是 Reviewer，在对代码修改不是特别有把握的时候，我会请教更资深的程序员来一起 Review，古话说，三人行必有我师焉，来看看别人有什么建议。

另外，我觉得想成为一个优秀的程序员，那么一定要有“品味”，而且品味是能够培养出来的。就跟看画展一样，你看到的优秀的作品越多，品味就会提升的越快，才会知道当初自己画的那个“小鸡吃米”不香了。因此要多看看外面的世界，尤其是那些大厂，大牛的代码。
